<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Audit de Conformit√© ‚Äì D2F Compliant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background-color: #f9f9f9; }
    h1, h2 { color: #222; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input, textarea, select {
      width: 100%; padding: 0.5em; margin-top: 0.2em;
      border-radius: 4px; border: 1px solid #bbb;
    }
    button {
      margin-top: 2em; padding: 0.75em 2em; background-color: #0066cc;
      color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    .question-block, .identite {
      background-color: #fff; border-radius: 6px; margin-bottom: 2em;
      padding: 1em; border: 1px solid #ccc;
    }
    .attendu {
      font-size: 0.9em; color: #333; background-color: #eef;
      padding: 0.5em; margin-top: 0.5em; border-left: 4px solid #88a;
    }
  </style>
</head>
<body>
<h1>Audit de Conformit√© ‚Äì D2F Compliant d.o.o</h1>

<label for="langSwitch">üåê Langue / Language</label>
<select id="langSwitch" onchange="changerLangue(this.value)">
  <option value="fr">Fran√ßais</option>
  <option value="en">English</option>
</select>

<div class="identite">
  <h2>üßæ Informations sur l'entit√© audit√©e</h2>
  <label for="societe">Nom de la soci√©t√©</label>
  <input id="societe">
  <label for="adresse">Adresse</label>
  <input id="adresse">
  <label for="participants">Participants</label>
  <textarea id="participants"></textarea>
</div>

<div id="questionnaire">
<script>
const exigences = [
  ["Unicit√© des factures", "Chaque facture doit comporter un identifiant unique, non r√©utilisable, chronologique et sans rupture de s√©quence. R√©f. BOI-CF-COM-10-10-20-60."],
  ["Horodatage serveur s√©curis√©", "Les op√©rations doivent √™tre horodat√©es depuis une source fiable (NTP), stock√©es de mani√®re inviolable. R√©f. Annexe 2 NF525."],
  ["Cha√Ænage des journaux d‚Äô√©v√©nements", "Chaque √©v√©nement du journal doit comporter le hash de l‚Äô√©v√©nement pr√©c√©dent (HMAC/SHA256 recommand√©)."],
  ["Archivage probant", "Archivage √† valeur probante selon la norme NF Z42-020 : int√©grit√©, lisibilit√©, disponibilit√©, tra√ßabilit√©."],
  ["Validation des exports fiscaux", "Tous les fichiers fiscaux (FEC, Factur-X) doivent √™tre valides au format XSD fourni par l‚Äôadministration."],
  ["Acc√®s auditeur s√©curis√©", "Un acc√®s en lecture seule aux donn√©es et journaux doit √™tre pr√©vu pour l‚Äôaudit fiscal. R√©f. BOI-CF-COM-10-10-20-60."],
  ["Authentification forte", "L'acc√®s aux fonctions sensibles doit √™tre prot√©g√© par MFA ou √©quivalent s√©curis√©. Conforme RGPD & ANSSI."],
  ["Mentions fiscales automatiques", "Les mentions obligatoires doivent √™tre g√©n√©r√©es automatiquement selon le type de document. R√©f. CGI art. 242 nonies A."],
  ["Conservation des journaux 6 ans", "Les journaux d‚Äô√©v√©nements doivent √™tre conserv√©s 6 ans et consultables sur demande."],
  ["Tra√ßabilit√© des paiements", "Chaque encaissement/acompte doit √™tre reli√© √† une facture et journalis√©."],
  ["Annulation/modification document", "Toute modification ou annulation doit √™tre trac√©e et justifi√©e avec timestamp. R√©f. NF525."],
  ["Suivi de cycle de vie", "Statuts initiaux, valid√©s, annul√©s, avoirs doivent √™tre trac√©s et archiv√©s."],
  ["Export structur√© interop√©rable", "Les formats de facture doivent respecter EN 16931 ou Factur-X. R√©f. BOI-TVA-DECLA-30-20-30."],
  ["Validation XSD et profil CIUS-FR", "Chaque facture doit √™tre conforme √† son profil syntaxique. CIUS-FR recommand√©."],
  ["Contr√¥le des remises", "Les remises commerciales doivent √™tre justifi√©es, trac√©es et enregistr√©es."],
  ["Gestion des duplicatas", "La r√©√©dition d‚Äôun document doit √™tre trac√©e et marqu√©e comme duplicata."],
  ["Journalisation des acc√®s utilisateurs", "Chaque action utilisateur doit √™tre logu√©e avec date, heure, nature de l‚Äôaction."],
  ["Num√©rotation continue", "La num√©rotation des pi√®ces doit √™tre continue sans rupture, format param√©trable."],
  ["Signature √©lectronique", "La signature √©lectronique qualifi√©e est recommand√©e pour les envois vers les PDP."],
  ["Archivage des annexes", "Les pi√®ces jointes (devis, bons, etc.) doivent √™tre associ√©es √† la facture et archiv√©es."],
  ["Mentions obligatoires facture (papier/√©lectronique)", "La facture doit contenir les mentions l√©gales pr√©vues par l‚Äôarticle 242 nonies A du CGI."],
  ["Respect format structur√© Factur-X/UBL", "Le fichier transmis doit respecter le profil minimum (BASIC WL ou CIUS-FR). R√©f. EN 16931."],
  ["Lien facture avec documents source", "Les r√©f√©rences aux documents d‚Äôorigine doivent √™tre pr√©sentes : devis, commande (BT-17, BT-18)."],
  ["Journalisation √©mission + transmission", "L‚Äô√©mission et la transmission doivent √™tre enregistr√©es dans un journal d‚Äôaudit s√©curis√©."],
  ["Gestion des accus√©s PDP et rejets", "Les statuts ‚Äòd√©pos√©e‚Äô, ‚Äòrejet√©e‚Äô, ‚Äòaccept√©e‚Äô doivent √™tre journalis√©s avec r√©ponse PDP."],
  ["Archivage probant cha√Æn√©", "Les factures archiv√©es doivent √™tre cha√Æn√©es entre elles ou sign√©es individuellement."],
  ["Mise √† jour CDAR", "Le SI doit pouvoir synchroniser les statuts CDAR (Cycle De Vie) avec les retours PDP."],
  ["Transmission conforme CIUS/CTC-FR", "Le format transmis doit respecter les sp√©cifications CTC-FR ou CIUS-FR."],
  ["Tra√ßabilit√© multi-PDP", "Le syst√®me doit router les factures vers la bonne PDP selon identifiant client (SIRET, PEPPOL ID)."],
  ["R√©conciliation livraisons/statuts", "Le SI doit rapprocher les transmissions envoy√©es avec les statuts de r√©ception."]
];

const qform = document.getElementById("questionnaire");
exigences.forEach((e, i) => {
  const bloc = document.createElement("div");
  bloc.className = "question-block";
  bloc.innerHTML = `<h2>${i + 1}. ${e[0]}</h2>
    <div class="attendu">${e[1]}</div>
    <label for="rep${i}">R√©ponse</label>
    <textarea id="rep${i}"></textarea>
    <label for="preuve${i}">Preuve</label>
    <textarea id="preuve${i}"></textarea>
    <label for="conf${i}">Conformit√©</label>
    <select id="conf${i}">
      <option value="">-- Choisir --</option>
      <option value="‚úÖ Conforme">‚úÖ Conforme</option>
      <option value="‚ùå Non Conforme">‚ùå Non Conforme</option>
      <option value="‚ö†Ô∏è Partiellement Conforme">‚ö†Ô∏è Partiellement Conforme</option>
    </select>`;
  qform.appendChild(bloc);
});
</script>
</div>

<button onclick="genererPDF()">üìÑ Exporter le rapport PDF</button>

<script>
async function genererPDF() {
  const doc = new window.jspdf.jsPDF();
  let y = 10;
  let conforme = 0, nonConforme = 0, partiel = 0;
  doc.setFontSize(14);
  doc.text("Rapport d'Audit ‚Äì D2F Compliant d.o.o", 105, y, null, null, "center");
  y += 10;
  doc.setFontSize(10);

  const inputs = document.querySelectorAll('.identite input, .identite textarea');
  inputs.forEach(el => {
    if (el.previousElementSibling) {
      doc.text(`${el.previousElementSibling.innerText} ${el.value}`, 10, y);
      y += 6;
    }
  });

  document.querySelectorAll('.question-block').forEach((block, i) => {
    const titre = block.querySelector('h2')?.innerText;
    const attendu = block.querySelector('.attendu')?.innerText;
    const reponse = block.querySelector('textarea:nth-of-type(1)')?.value;
    const preuve = block.querySelector('textarea:nth-of-type(2)')?.value;
    const conf = block.querySelector('select')?.value;

    if (conf.includes("Conforme")) conforme++;
    else if (conf.includes("Non Conforme")) nonConforme++;
    else if (conf.includes("Partiellement")) partiel++;

    doc.setFont(undefined, 'bold');
    doc.text(titre || `Exigence ${i+1}`, 10, y); y += 5;
    doc.setFont(undefined, 'normal');
    if (attendu) doc.text(attendu, 10, y); y += 5;
    doc.text("R√©ponse : " + (reponse || ""), 10, y); y += 5;
    doc.text("Preuve : " + (preuve || ""), 10, y); y += 5;
    doc.text("Conformit√© : " + (conf || ""), 10, y); y += 8;
    if (y > 270) { doc.addPage(); y = 10; }
  });

  doc.addPage();
  y = 10;
  doc.setFontSize(12);
  doc.text("üìä Synth√®se de conformit√©", 10, y); y += 8;
  doc.setFontSize(10);
  doc.text(`‚úÖ Conforme : ${conforme}`, 10, y); y += 5;
  doc.text(`‚ùå Non Conforme : ${nonConforme}`, 10, y); y += 5;
  doc.text(`‚ö†Ô∏è Partiellement Conforme : ${partiel}`, 10, y); y += 8;

  doc.setFontSize(10);
  doc.text("üìå Recommandations g√©n√©rales :", 10, y); y += 6;
  doc.text("- Documenter toute non-conformit√© d√©tect√©e.", 10, y); y += 5;
  doc.text("- Planifier une revue r√©guli√®re du syst√®me de facturation.", 10, y); y += 5;
  doc.text("- V√©rifier la synchronisation avec les obligations PDP.", 10, y); y += 5;
  doc.text("- Maintenir les journaux en acc√®s prot√©g√©.", 10, y); y += 5;

  const horo = new Date().toISOString();
doc.setFontSize(10);
doc.text(`üßÆ Note finale : ${((conforme / 30) * 20).toFixed(1)} / 20`, 10, y); y += 6;
doc.setFontSize(8);
doc.text(langues[lang].horodatage + horo, 10, y);
  const logo = new Image();
logo.src = '/mnt/data/Image1.jpg';
logo.onload = function() {
  doc.addImage(logo, 'JPEG', 150, y - 20, 40, 20);
  doc.save("rapport_audit_d2f.pdf");
};
}
}
</script>

<!-- ‚ö†Ô∏è R√âINSERTION AUTOMATIQUE DES 30 BLOCS DE QUESTIONS ICI SERA FAITE DANS LA PROCHAINE √âTAPE -->
<button onclick="genererPDF()">üìÑ Exporter le rapport PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const langues = {
  fr: {
    conforme: "‚úÖ Conforme",
    nonConforme: "‚ùå Non Conforme",
    partiel: "‚ö†Ô∏è Partiellement Conforme",
    exporter: "üìÑ Exporter le rapport PDF",
    horodatage: "Horodatage : "
  },
  en: {
    conforme: "‚úÖ Compliant",
    nonConforme: "‚ùå Non-Compliant",
    partiel: "‚ö†Ô∏è Partially Compliant",
    exporter: "üìÑ Export PDF Report",
    horodatage: "Timestamp: "
  }
};

const lang = (localStorage.getItem('langue') || 'fr');
function genererPDF() {
  const doc = new window.jspdf.jsPDF();
  let y = 10;
  doc.setFontSize(14);
  doc.text("Rapport d'Audit ‚Äì D2F Compliant d.o.o", 105, y, null, null, "center");
  y += 10;
  doc.setFontSize(10);

  const inputs = document.querySelectorAll('.identite input, .identite textarea');
  inputs.forEach(el => {
    if (el.previousElementSibling) {
      doc.text(`${el.previousElementSibling.innerText} ${el.value}`, 10, y);
      y += 6;
    }
  });

  document.querySelectorAll('.question-block').forEach((block, i) => {
    const titre = block.querySelector('h2')?.innerText;
    const attendu = block.querySelector('.attendu')?.innerText;
    const reponse = block.querySelector('textarea:nth-of-type(1)')?.value;
    const preuve = block.querySelector('textarea:nth-of-type(2)')?.value;
    const conf = block.querySelector('select')?.value;

    doc.setFont(undefined, 'bold');
    doc.text(titre || `Exigence ${i+1}`, 10, y); y += 5;
    doc.setFont(undefined, 'normal');
    if (attendu) doc.text(attendu, 10, y); y += 5;
    doc.text("R√©ponse : " + (reponse || ""), 10, y); y += 5;
    doc.text("Preuve : " + (preuve || ""), 10, y); y += 5;
    doc.text("Conformit√© : " + (conf || ""), 10, y); y += 8;
    if (y > 270) { doc.addPage(); y = 10; }
  });

  const horo = new Date().toISOString();
  doc.setFontSize(8);
  doc.text(langues[lang].horodatage + horo, 10, y);
  doc.save("rapport_audit_d2f.pdf");
}
</script>
</body>
</html>
